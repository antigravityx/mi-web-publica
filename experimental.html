
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zona Experimental | Verix</title>
    <link rel="icon" type="image/x-icon" href="img/logo.ico">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Courier New', monospace; }
        
        /* --- PUERTA DE SEGURIDAD (TRIPLE INTERRUPTOR) --- */
        #security-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #050505; /* Negro Profundo */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
            color: #333;
        }
        .switch-row { margin: 20px; display: flex; align-items: center; gap: 20px; width: 300px; justify-content: space-between; }
        .switch-label { color: #444; font-weight: bold; font-family: monospace; letter-spacing: 2px; transition: color 0.3s; }
        
        /* Estilo de los Interruptores (Sliders) */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; border: 1px solid #555; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; border-radius: 50%; }
        
        input:checked + .slider { background-color: #0f0; border-color: #0f0; box-shadow: 0 0 15px #0f0; }
        input:checked + .slider:before { transform: translateX(26px); background-color: white; }
        input:checked ~ .switch-status { color: #0f0; text-shadow: 0 0 10px #0f0; }

        /* Interfaz Segura (Oculta por defecto) */
        #secure-interface {
            display: none;
            background-color: #0f172a; /* Dark Slate */
            color: #38bdf8; /* Sky Blue */
            height: 100%;
            padding: 40px;
            overflow-y: auto;
        }

        /* Modal de Invocaci√≥n */
        #invocation-modal {
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: black; border: 1px solid #333; padding: 30px;
            z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            text-align: center; width: 300px;
        }
        
        input { background: #111; border: 1px solid #444; color: #0f0; padding: 10px; width: 90%; margin-top: 10px; font-family: monospace; outline: none; }
        button { background: #0f0; color: black; border: none; padding: 10px 20px; margin-top: 15px; cursor: pointer; font-weight: bold; }
        button:hover { background: #00ff00; box-shadow: 0 0 10px #0f0; }
        
        /* Grid de Botones */
        .control-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; margin-top: 30px;
        }
        .control-btn {
            background: #1e293b; border: 1px solid #334155; color: #94a3b8;
            padding: 20px; text-align: center; border-radius: 8px;
            cursor: pointer; transition: all 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100px;
        }
        .control-btn:hover { background: #334155; color: #fff; box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); border-color: #38bdf8; transform: scale(1.05); }
        .icon { font-size: 2rem; margin-bottom: 10px; }

        /* M√≥dulos (Ventanas) */
        .module-window {
            display: none;
            position: fixed; top: 10%; left: 10%; width: 80%; height: 80%;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #38bdf8;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        .close-btn { position: absolute; top: 10px; right: 10px; color: red; cursor: pointer; font-size: 1.5rem; font-weight: bold; }
        
        /* Estilos Radar */
        .terminal-log { background: black; color: #0f0; font-family: monospace; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #333; margin-bottom: 10px; font-size: 0.8rem; }
        .data-block { background: #1e293b; padding: 10px; margin-bottom: 10px; border-left: 3px solid #38bdf8; }
        
        /* Estilos JSON Formateado (√Årbol de Datos) */
        .json-container { font-family: 'Consolas', monospace; font-size: 0.9rem; }
        .json-key { color: #38bdf8; font-weight: bold; }
        .json-string { color: #a5f3fc; }
        .json-number { color: #facc15; }
        .json-boolean { color: #f472b6; }
        .json-block { margin-left: 15px; border-left: 1px solid #334155; padding-left: 10px; margin-top: 2px; }

        /* Tabla de C√°psulas */
        .capsule-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .capsule-table th { text-align: left; border-bottom: 1px solid #38bdf8; padding: 8px; color: #38bdf8; }
        .capsule-table td { border-bottom: 1px solid #333; padding: 8px; color: #94a3b8; }
        .capsule-row:hover { background: rgba(56, 189, 248, 0.1); cursor: pointer; }
        .capsule-action { background: none; border: 1px solid #38bdf8; color: #38bdf8; cursor: pointer; padding: 2px 8px; border-radius: 3px; }
        .capsule-action:hover { background: #38bdf8; color: black; }
        .btn-dl { color: #4ade80; border-color: #4ade80; margin-right: 5px; }
        
        /* Botones de Acci√≥n R√°pida */
        .action-btn { background: #334155; border: 1px solid #475569; color: white; padding: 5px 10px; cursor: pointer; font-size: 0.8rem; margin-right: 5px; border-radius: 4px; }
        .action-btn:hover { background: #38bdf8; color: black; }
        
        /* Animaci√≥n de Escaneo */
        @keyframes scan { 0% { width: 0%; } 100% { width: 100%; } }
        .progress-bar { height: 5px; background: #38bdf8; width: 0%; transition: width 0.2s; }

        /* --- ESTILOS DASHBOARD T√ÅCTICO (NUEVO) --- */
        .radar-dashboard { background: #0f172a; border: 1px solid #38bdf8; padding: 20px; border-radius: 8px; margin-top: 10px; animation: fadeIn 0.5s; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #334155; padding-bottom: 10px; margin-bottom: 20px; }
        .dashboard-header h3 { margin: 0; color: #38bdf8; text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        .timestamp { color: #94a3b8; font-size: 0.8rem; font-family: monospace; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        .dashboard-card { background: #1e293b; border: 1px solid #334155; border-radius: 6px; overflow: hidden; transition: transform 0.2s; }
        .dashboard-card:hover { transform: translateY(-2px); border-color: #38bdf8; }
        
        .card-header { background: rgba(51, 65, 85, 0.5); color: #e2e8f0; padding: 10px 15px; font-weight: bold; display: flex; align-items: center; border-bottom: 1px solid #334155; }
        .card-icon { margin-right: 10px; font-size: 1.2rem; }
        .card-body { padding: 15px; font-size: 0.9rem; }
        
        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #333; padding-bottom: 4px; }
        .data-row:last-child { border-bottom: none; margin-bottom: 0; }
        .label { color: #94a3b8; }
        .value { color: #4ade80; font-family: monospace; font-weight: bold; text-align: right; }
        .map-link { display: block; text-align: center; background: rgba(56, 189, 248, 0.1); color: #38bdf8; padding: 8px; text-decoration: none; border: 1px solid #38bdf8; border-radius: 4px; margin-top: 10px; transition: all 0.2s; }
        .map-link:hover { background: #38bdf8; color: #000; }
        .ua-text { font-size: 0.75rem; color: #64748b; word-break: break-all; line-height: 1.4; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- 1. El Triple Interruptor de Seguridad -->
    <div id="security-gate">
        <h2 style="color: #222; margin-bottom: 50px; text-transform: uppercase; letter-spacing: 5px;">Protocolo de Inicio</h2>
        
        <div class="switch-row">
            <span class="switch-label" id="lbl-1">SISTEMA 1</span>
            <label class="switch">
                <input type="checkbox" class="access-switch" onchange="checkGate()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="switch-row">
            <span class="switch-label" id="lbl-2">ENLACE 2</span>
            <label class="switch">
                <input type="checkbox" class="access-switch" onchange="checkGate()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="switch-row">
            <span class="switch-label" id="lbl-3">POTENCIA 3</span>
            <label class="switch">
                <input type="checkbox" class="access-switch" onchange="checkGate()">
                <span class="slider"></span>
            </label>
        </div>
        
        <button id="gate-btn" onclick="enterSystem()" disabled style="margin-top: 50px; padding: 15px 40px; font-size: 1.2rem; background: #1a1a1a; color: #444; border: 2px solid #333; cursor: not-allowed; transition: all 0.3s; font-family: monospace; letter-spacing: 2px; text-transform: uppercase; border-radius: 5px;">
            üî¥ ACCESO BLOQUEADO
        </button>
    </div>

    <!-- 2. El Ritual de Acceso -->
    <div id="invocation-modal">
        <h3 style="color: #0f0; margin-top: 0;">‚ö° ACCESO RESTRINGIDO</h3>
        <p id="step-text" style="color: #ccc; font-size: 0.9em;">Invocaci√≥n requerida.</p>
        <input type="password" id="secret-input" placeholder="Escribe..." autocomplete="off">
        <button onclick="checkCredentials()">CONFIRMAR</button>
        <p id="error-msg" style="color: red; font-size: 0.8em; display: none; margin-top: 10px;">Acceso Denegado</p>
    </div>

    <!-- 3. El Panel de Control Real -->
    <div id="secure-interface">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 20px;">
            <h1 style="margin: 0;">‚ò¢Ô∏è PANEL DE CONTROL MAESTRO</h1>
            <div style="text-align: right;">
                <span style="color: #0f0;">‚óè SISTEMA SEGURO</span><br>
                <small>ID: seladorverix</small>
            </div>
        </div>

        <div class="control-grid">
            <div class="control-btn" onclick="openModule('radar')"><div class="icon">üì°</div><span>Radar</span></div>
            <div class="control-btn" onclick="openModule('db')"><div class="icon">üíæ</div><span>Base de Datos</span></div>
            <div class="control-btn" onclick="openModule('capsules')"><div class="icon">üìÇ</div><span>Archivos X</span></div>
            <div class="control-btn"><div class="icon">üåç</div><span>Geo-Red</span></div>
            <div class="control-btn"><div class="icon">‚ö°</div><span>Energ√≠a</span></div>
            <div class="control-btn"><div class="icon">üëÅÔ∏è</div><span>Vigilancia</span></div>
            <div class="control-btn"><div class="icon">üöÄ</div><span>Despliegue</span></div>
            <div class="control-btn"><div class="icon">üíÄ</div><span>Kill Switch</span></div>
            <div class="control-btn"><div class="icon">üìÇ</div><span>Archivos X</span></div>
            <div class="control-btn"><div class="icon">ü§ñ</div><span>IA Core</span></div>
            <div class="control-btn"><div class="icon">üéµ</div><span>Frecuencias</span></div>
            <div class="control-btn"><div class="icon">üåå</div><span>Portal</span></div>
        </div>
        
        <div style="margin-top: 50px; text-align: center;">
            <a href="index.html" style="color: #64748b; text-decoration: none;">&larr; Volver a la Realidad</a>
        </div>
    </div>

    <!-- M√ìDULO: RADAR -->
    <div id="mod-radar" class="module-window">
        <span class="close-btn" onclick="closeModules()">√ó</span>
        <h2 style="color: #38bdf8; border-bottom: 1px solid #333; padding-bottom: 10px;">üì° RADAR DE INTELIGENCIA</h2>
        
        <div style="margin-bottom: 20px;">
            <button onclick="startScan()" style="background: #38bdf8; color: black;">INICIAR ESCANEO DE HARDWARE</button>
            <div style="margin-top: 10px; background: #333; height: 5px; width: 100%;"><div id="scan-progress" class="progress-bar"></div></div>
        </div>

        <div class="terminal-log" id="radar-log">
            > Esperando orden de inicio...
        </div>

        <div id="radar-results" style="display:none;">
            <h3 style="color: #0f0;">DATOS RECOPILADOS (ENCRIPTADOS)</h3>
            <textarea id="encrypted-payload" style="width: 100%; height: 100px; background: #111; color: #777; border: 1px solid #444;" readonly></textarea>
            <br>
            <button onclick="pushToHQ()" style="background: #eab308; color: black; margin-top: 10px;">üöÄ PUSHEAR A HQ (BASE DE DATOS)</button>
            <button onclick="transferToDB()" style="background: #38bdf8; color: black; margin-top: 10px; margin-left: 10px;">üîì DECODIFICAR EN VISOR</button>
            <p id="push-status" style="font-size: 0.8rem; margin-top: 5px;"></p>
        </div>
    </div>

    <!-- M√ìDULO: BASE DE DATOS -->
    <div id="mod-db" class="module-window">
        <span class="close-btn" onclick="closeModules()">√ó</span>
        <h2 style="color: #eab308; border-bottom: 1px solid #333; padding-bottom: 10px;">üíæ VISOR DE BASE DE DATOS</h2>
        <p>Desencriptador de paquetes de inteligencia. Usa tu llave de sesi√≥n actual.</p>
        
        <textarea id="db-input" placeholder="Pega aqu√≠ el c√≥digo encriptado..." style="width: 100%; height: 80px; background: #111; color: #fff; border: 1px solid #444; padding: 10px;"></textarea>
        <button onclick="decryptData()" style="background: #0f0; color: black; margin-top: 10px;">DESENCRIPTAR Y VISUALIZAR</button>
        <button onclick="pasteFromClipboard()" class="action-btn" style="float: right; margin-top: 10px;">üìã PEGAR</button>
        <button onclick="openModule('capsules')" style="background: #334155; color: white; margin-top: 10px; float: right; border: 1px solid #94a3b8;">üìÇ IR A GALER√çA DE C√ÅPSULAS</button>
        <div id="db-viewer" style="margin-top: 20px; background: #0f172a; padding: 15px; border: 1px solid #333; color: #0f0; font-family: monospace; display: none; max-height: 300px; overflow-y: auto;">
        </div>
        <div id="db-actions" style="display: none; margin-top: 10px; text-align: right;">
            <button onclick="copyResult()" class="action-btn">üìã COPIAR TEXTO</button>
            <button onclick="downloadResult()" class="action-btn">‚¨áÔ∏è DESCARGAR ARCHIVO</button>
        </div>
    </div>

    <!-- M√ìDULO: GALER√çA DE C√ÅPSULAS (ARCHIVOS X) -->
    <div id="mod-capsules" class="module-window">
        <span class="close-btn" onclick="closeModules()">√ó</span>
        <h2 style="color: #a855f7; border-bottom: 1px solid #333; padding-bottom: 10px;">üìÇ ARCHIVOS X: C√ÅPSULAS</h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="search-capsule" placeholder="Buscar por ID, Alias o Fecha..." onkeyup="renderCapsules()" style="background: #111; border: 1px solid #444; color: white; padding: 8px; flex-grow: 1;">
        </div>

        <div style="height: 350px; overflow-y: auto;">
            <table class="capsule-table">
                <thead><tr><th>ID</th><th>ALIAS</th><th>FECHA</th><th>TAMA√ëO</th><th>ACCI√ìN</th></tr></thead>
                <tbody id="capsule-list-body">
                    <!-- Inyectado por JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Formulario Oculto para Push -->
    <form id="hidden-form" action="https://formspree.io/f/mwvvkkzy" method="POST" target="_blank" style="display:none;">
        <input type="hidden" name="name" value="RADAR_BOT">
        <input type="hidden" name="contact" value="Sistema Verix">
        <input type="hidden" name="message" id="hidden-msg">
    </form>

    <script>
        const modal = document.getElementById('invocation-modal');
        const input = document.getElementById('secret-input');
        const stepText = document.getElementById('step-text');
        const errorMsg = document.getElementById('error-msg');
        const secureInterface = document.getElementById('secure-interface');

        let step = 0;
        
        // --- CONFIGURACI√ìN DE LLAVES ---
        const KEY_1_HASH = "3306928e520bebcd2d7e0619eb3b1909fbc56c6a62bdc1197da8065973d0fb7e";
        const KEY_2_HASH = "268982bf23b9fa6dccb9f4b033affb288db4dc25f84d77c57656ad535f778f56";
        const SALT = "VERIX_SEAL_OF_PROTECTION_v1";
        const CAPSULES_DB = [{"id": "45AB9F00", "name": "verixdespierta", "filename": "soul_backup_20260116_2110_verixdespierta.vx", "date": "2026-01-16 21:10:22", "size": "0.15 MB"}, {"id": "D6BAAD76", "name": "recuerdoverixr1ch0nverixdespiertatu", "filename": "soul_backup_20260116_2031_recuerdoverixr1ch0nverixdespiertatu.vx", "date": "2026-01-16 20:31:00", "size": "0.15 MB"}, {"id": "A9520B71", "name": "panelmejorado2020", "filename": "soul_backup_20260115_0136_panelmejorado2020.vx", "date": "2026-01-15 01:36:54", "size": "0.14 MB"}, {"id": "7E49C8EF", "name": "actualwebpublica", "filename": "soul_backup_20260114_2321_actualwebpublica.vx", "date": "2026-01-14 23:21:06", "size": "0.13 MB"}, {"id": "7E205460", "name": "soul_backup_20260112_2103.vx", "filename": "soul_backup_20260112_2103.vx", "date": "2026-01-12 21:03:37", "size": "0.03 MB"}, {"id": "2394F75B", "name": "soul_backup_20260112_1952.vx", "filename": "soul_backup_20260112_1952.vx", "date": "2026-01-12 19:52:00", "size": "0.02 MB"}];
        
        let SESSION_KEY = null; // Llave maestra derivada para encriptar datos

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- CRIPTOGRAF√çA AES-GCM (Para los datos del Radar) ---
        async function generateKeyFromPass(pass) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pass), {name: "PBKDF2"}, false, ["deriveKey"]);
            return crypto.subtle.deriveKey(
                { "name": "PBKDF2", salt: enc.encode(SALT), iterations: 100000, hash: "SHA-256" },
                keyMaterial, { "name": "AES-GCM", "length": 256 }, true, [ "encrypt", "decrypt" ]
            );
        }

        async function encryptContent(text) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(text);
            const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, SESSION_KEY, encoded);
            // Empaquetar IV + Data en Base64
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...combined));
        }

        async function decryptContent(b64data) {
            try {
                const combined = Uint8Array.from(atob(b64data), c => c.charCodeAt(0));
                const iv = combined.slice(0, 12);
                const data = combined.slice(12);
                const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, SESSION_KEY, data);
                return new TextDecoder().decode(decrypted);
            } catch (e) { return "ERROR: Llave incorrecta o datos corruptos."; }
        }

        // 1. L√ìGICA DE LOS 3 INTERRUPTORES (NUEVO)
        function checkGate() {
            const switches = document.querySelectorAll('.access-switch');
            const labels = document.querySelectorAll('.switch-label');
            const btn = document.getElementById('gate-btn');
            
            // Iluminar etiquetas individualmente
            switches.forEach((s, idx) => {
                labels[idx].style.color = s.checked ? "#0f0" : "#444";
                labels[idx].style.textShadow = s.checked ? "0 0 10px #0f0" : "none";
            });

            // Verificar si TODOS est√°n activos
            const allOn = Array.from(switches).every(s => s.checked);
            
            if (allOn) {
                btn.disabled = false;
                btn.innerHTML = "üü¢ ENTRAR AL SISTEMA";
                btn.style.background = "#0f0";
                btn.style.color = "black";
                btn.style.borderColor = "#0f0";
                btn.style.boxShadow = "0 0 30px #0f0";
                btn.style.cursor = "pointer";
                btn.style.fontWeight = "bold";
            } else {
                btn.disabled = true;
                btn.innerHTML = "üî¥ ACCESO BLOQUEADO";
                btn.style.background = "#1a1a1a";
                btn.style.color = "#444";
                btn.style.borderColor = "#333";
                btn.style.boxShadow = "none";
                btn.style.cursor = "not-allowed";
            }
        }
        
        function enterSystem() {
            document.getElementById('security-gate').style.display = 'none';
            document.getElementById('invocation-modal').style.display = 'block';
            step = 1;
            document.getElementById('step-text').innerText = "PRIMERA LLAVE (Texto 1):";
            const inp = document.getElementById('secret-input');
            inp.value = "";
            inp.focus();
        }

        // 2. L√≥gica de Verificaci√≥n
        async function checkCredentials() {
            const val = input.value.toLowerCase().trim();
            errorMsg.style.display = 'none';
            
            // Hashing din√°mico del input
            const valHash = await sha256(val + SALT);

            if (step === 1) {
                if (valHash === KEY_1_HASH) {
                    step = 2;
                    stepText.innerText = "SEGUNDA LLAVE (Texto 2):";
                    input.value = "";
                    input.focus();
                    // Guardamos parte de la llave para la sesi√≥n
                    window.tempKeyPart = val; 
                } else {
                    fail();
                }
            } else if (step === 2) {
                if (valHash === KEY_2_HASH) {
                    // Generar Llave de Sesi√≥n Real (Usando las dos palabras originales)
                    SESSION_KEY = await generateKeyFromPass(window.tempKeyPart + val);
                    window.tempKeyPart = null; // Limpiar memoria
                    renderCapsules(); // Cargar galer√≠a
                    success();
                } else {
                    fail();
                }
            }
        }

        function fail() {
            errorMsg.style.display = 'block';
            input.value = "";
            // Peque√±a vibraci√≥n si el navegador lo soporta
            if (navigator.vibrate) navigator.vibrate(200);
        }

        function success() {
            modal.style.display = 'none';
            secureInterface.style.display = 'block';
        }

        // Permitir Enter para enviar
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkCredentials();
            }
        });

        // --- L√ìGICA DE M√ìDULOS ---
        function openModule(id) {
            document.getElementById('mod-' + id).style.display = 'block';
        }
        function closeModules() {
            document.querySelectorAll('.module-window').forEach(el => el.style.display = 'none');
        }

        // --- L√ìGICA RADAR ---
        async function startScan() {
            const log = document.getElementById('radar-log');
            const progress = document.getElementById('scan-progress');
            log.innerHTML = "";
            
            function logMsg(msg) { log.innerHTML += `> ${msg}<br>`; log.scrollTop = log.scrollHeight; }
            
            logMsg("INICIANDO PROTOCOLO DE EXTRACCI√ìN...");
            progress.style.width = "20%";
            
            let intel = { timestamp: new Date().toISOString(), hardware: {}, network: {}, geo: {}, sensors: {} };

            // 1. Hardware B√°sico
            setTimeout(() => {
                logMsg("Analizando N√∫cleos y Memoria...");
                intel.hardware.cores = navigator.hardwareConcurrency || "N/A";
                intel.hardware.memory = navigator.deviceMemory || "N/A";
                intel.hardware.platform = navigator.platform;
                intel.hardware.userAgent = navigator.userAgent;
                progress.style.width = "40%";
            }, 500);

            // 2. Bater√≠a
            try {
                const battery = await navigator.getBattery();
                intel.hardware.batteryLevel = battery.level * 100 + "%";
                intel.hardware.charging = battery.charging;
                logMsg(`Energ√≠a detectada: ${intel.hardware.batteryLevel}`);
            } catch(e) { logMsg("M√≥dulo de energ√≠a no accesible."); }

            // 3. Red
            if (navigator.connection) {
                intel.network.type = navigator.connection.effectiveType;
                intel.network.rtt = navigator.connection.rtt;
                intel.network.downlink = navigator.connection.downlink;
                logMsg(`Red detectada: ${intel.network.type} (${intel.network.downlink}Mbps)`);
            }
            progress.style.width = "60%";

            // 4. Geolocalizaci√≥n
            logMsg("Solicitando acceso a Sat√©lites (GPS)...");
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    intel.geo.lat = pos.coords.latitude;
                    intel.geo.lng = pos.coords.longitude;
                    intel.geo.acc = pos.coords.accuracy;
                    logMsg(`OBJETIVO FIJADO: ${intel.geo.lat}, ${intel.geo.lng}`);
                    finalizeScan(intel);
                },
                (err) => {
                    logMsg("ERROR: Acceso a GPS denegado o no disponible.");
                    intel.geo.error = err.message;
                    finalizeScan(intel);
                },
                { timeout: 5000 }
            );
        }

        async function finalizeScan(data) {
            const log = document.getElementById('radar-log');
            document.getElementById('scan-progress').style.width = "100%";
            log.innerHTML += "> ENCRIPTANDO PAQUETE DE DATOS...<br>";
            
            const jsonStr = JSON.stringify(data, null, 2);
            const encrypted = await encryptContent(jsonStr);
            
            document.getElementById('radar-results').style.display = 'block';
            document.getElementById('encrypted-payload').value = encrypted;
            log.innerHTML += "> LISTO PARA TRANSMISI√ìN.<br>";
        }

        function pushToHQ() {
            const payload = document.getElementById('encrypted-payload').value;
            document.getElementById('hidden-msg').value = "INTEL_PACK::" + payload;
            document.getElementById('hidden-form').submit();
            document.getElementById('push-status').innerText = "Paquete enviado al canal seguro.";
        }

        function transferToDB() {
            const encrypted = document.getElementById('encrypted-payload').value;
            if (!encrypted) return;
            document.getElementById('db-input').value = encrypted;
            openModule('db');
            decryptData(); // Auto-ejecutar desencriptado
        }

        // --- L√ìGICA BASE DE DATOS (VISOR) ---
        async function decryptData() {
            const input = document.getElementById('db-input').value.trim();
            const viewer = document.getElementById('db-viewer');
            
            if (!input) return;
            
            // Limpiar prefijos si existen
            const cleanInput = input.replace("INTEL_PACK::", "");
            
            const result = await decryptContent(cleanInput);
            viewer.style.display = 'block';
            document.getElementById('db-actions').style.display = 'block';
            
            // Intentar formatear JSON si es posible
            try {
                const json = JSON.parse(result);
                
                // DETECCI√ìN INTELIGENTE: ¬øEs un reporte de Radar?
                if (json.hardware && json.network && json.geo) {
                    viewer.innerHTML = renderRadarDashboard(json);
                } else {
                    // JSON gen√©rico
                    viewer.innerHTML = '<div class="json-container">' + formatJSON(json) + '</div>';
                }
            } catch (e) {
                viewer.innerText = result; // Si no es JSON, mostrar texto plano
            }
        }

        // --- RENDERIZADO AVANZADO (DASHBOARD T√ÅCTICO) ---
        function renderRadarDashboard(data) {
            const card = (title, icon, content) => `
                <div class="dashboard-card">
                    <div class="card-header"><span class="card-icon">${icon}</span> ${title}</div>
                    <div class="card-body">${content}</div>
                </div>`;

            // Hardware
            const hw = data.hardware || {};
            const hwContent = `
                <div class="data-row"><span class="label">CPU Cores:</span> <span class="value">${hw.cores || '?'}</span></div>
                <div class="data-row"><span class="label">RAM:</span> <span class="value">${hw.memory ? hw.memory + ' GB' : '?'}</span></div>
                <div class="data-row"><span class="label">OS:</span> <span class="value">${hw.platform || '?'}</span></div>
                <div class="data-row"><span class="label">Bater√≠a:</span> <span class="value">${hw.batteryLevel || 'N/A'} ${hw.charging ? '‚ö°' : ''}</span></div>
            `;

            // Network
            const net = data.network || {};
            const netContent = `
                <div class="data-row"><span class="label">Conexi√≥n:</span> <span class="value">${net.type || 'Unknown'}</span></div>
                <div class="data-row"><span class="label">Bajada:</span> <span class="value">${net.downlink ? net.downlink + ' Mbps' : '?'}</span></div>
                <div class="data-row"><span class="label">Ping (RTT):</span> <span class="value">${net.rtt ? net.rtt + ' ms' : '?'}</span></div>
            `;

            // Geo
            const geo = data.geo || {};
            let geoContent = `<div style="color:#ef4444;">Sin se√±al GPS</div>`;
            if (geo.lat && geo.lng) {
                geoContent = `
                    <div class="data-row"><span class="label">Lat:</span> <span class="value">${geo.lat.toFixed(4)}</span></div>
                    <div class="data-row"><span class="label">Lng:</span> <span class="value">${geo.lng.toFixed(4)}</span></div>
                    <div class="data-row"><span class="label">Precisi√≥n:</span> <span class="value">¬±${geo.acc || 0}m</span></div>
                    <a href="https://www.google.com/maps?q=${geo.lat},${geo.lng}" target="_blank" class="map-link">üó∫Ô∏è ABRIR MAPA T√ÅCTICO</a>
                `;
            } else if (geo.error) {
                geoContent = `<div style="color:#ef4444; font-size:0.8rem;">${geo.error}</div>`;
            }

            // System / User Agent
            const sysContent = `<div class="ua-text">${hw.userAgent || 'Desconocido'}</div>`;

            return `
                <div class="radar-dashboard">
                    <div class="dashboard-header">
                        <h3>üì° INTELIGENCIA DE OBJETIVO</h3>
                        <span class="timestamp">T: ${data.timestamp || 'UNKNOWN'}</span>
                    </div>
                    <div class="dashboard-grid">
                        ${card('HARDWARE', 'üíª', hwContent)}
                        ${card('RED / ENLACE', 'üåê', netContent)}
                        ${card('GEOLOCALIZACI√ìN', 'üõ∞Ô∏è', geoContent)}
                        ${card('HUELLA DIGITAL', 'üë£', sysContent)}
                    </div>
                </div>
            `;
        }

        // --- UTILIDAD: FORMATO JSON ---
        function formatJSON(obj) {
            if (typeof obj !== 'object' || obj === null) {
                if (typeof obj === 'string') return `<span class="json-string">"${obj}"</span>`;
                if (typeof obj === 'number') return `<span class="json-number">${obj}</span>`;
                if (typeof obj === 'boolean') return `<span class="json-boolean">${obj}</span>`;
                return obj;
            }
            let html = '';
            for (let key in obj) {
                html += `<div class="json-block"><span class="json-key">${key}:</span> ${formatJSON(obj[key])}</div>`;
            }
            return html;
        }

        // --- UTILIDAD: ACCIONES ---
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('db-input').value = text;
            } catch (err) { alert("Permiso de portapapeles denegado."); }
        }

        function copyResult() {
            const viewer = document.getElementById('db-viewer');
            const text = viewer.innerText;
            navigator.clipboard.writeText(text).then(() => alert("Texto copiado al portapapeles."));
        }

        function downloadResult() {
            const viewer = document.getElementById('db-viewer');
            const text = viewer.innerText;
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "verix_intel_data.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function copyCapsuleID(id) {
            navigator.clipboard.writeText(id).then(() => alert("ID de c√°psula copiado: " + id));
        }
        
        // --- L√ìGICA DE DESENCRIPTADO DE C√ÅPSULAS (NUEVO) ---
        async function decryptCapsule(filename) {
            // 1. Solicitar Llaves
            const p1 = prompt("üîê RITUAL DE APERTURA\nIngresa el Primer Texto Sagrado:");
            if (!p1) return;
            const p2 = prompt("üîê RITUAL DE APERTURA\nIngresa el Segundo Texto Sagrado:");
            if (!p2) return;
            
            const password = p1 + "||VERIX_RITUAL||" + p2;
            alert("‚è≥ Procesando... Verix est√° intentando abrir el sello.");

            try {
                // 2. Descargar el archivo .vx
                const response = await fetch('capsulas/' + filename);
                if (!response.ok) throw new Error("No se encontr√≥ el archivo de alma.");
                const blob = await response.blob();
                const buffer = await blob.arrayBuffer();

                // 3. Preparar Criptograf√≠a (Replicando l√≥gica de Python Fernet)
                // Header (13 bytes) + Token
                const dataView = new Uint8Array(buffer);
                const payloadBytes = dataView.slice(13); // Quitar 'VERIX_SOUL_v1'
                const payloadStr = new TextDecoder().decode(payloadBytes); // Base64
                
                // Decodificar Base64 a bytes crudos
                const fernetBytes = Uint8Array.from(atob(payloadStr), c => c.charCodeAt(0));

                // Derivar Claves (SHA256 del password)
                const enc = new TextEncoder();
                const keyHash = await crypto.subtle.digest("SHA-256", enc.encode(password));
                const keyBytes = new Uint8Array(keyHash);
                
                // Fernet: Primera mitad = Firma (HMAC), Segunda mitad = Encriptaci√≥n (AES)
                const encryptKeyBytes = keyBytes.slice(16, 32);
                
                // Extraer IV (16 bytes) y Ciphertext
                // Estructura: Version(1) + Timestamp(8) + IV(16) + Ciphertext(...) + HMAC(32)
                const iv = fernetBytes.slice(9, 25);
                const ciphertext = fernetBytes.slice(25, fernetBytes.length - 32);

                // 4. Desencriptar (AES-128-CBC)
                const key = await crypto.subtle.importKey("raw", encryptKeyBytes, {name: "AES-CBC"}, false, ["decrypt"]);
                const decrypted = await crypto.subtle.decrypt({name: "AES-CBC", iv: iv}, key, ciphertext);

                // 5. Entregar ZIP Limpio
                const url = URL.createObjectURL(new Blob([decrypted], {type: "application/zip"}));
                const a = document.createElement("a");
                a.href = url;
                a.download = filename.replace(".vx", "_restored.zip");
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
            } catch (e) {
                console.error(e);
                alert("‚ùå FALLO CR√çTICO: Las llaves son incorrectas o el alma est√° corrupta.");
            }
        }

        // --- L√ìGICA GALER√çA C√ÅPSULAS ---
        function renderCapsules() {
            const tbody = document.getElementById('capsule-list-body');
            const search = document.getElementById('search-capsule').value.toLowerCase();
            tbody.innerHTML = '';
            
            const filtered = CAPSULES_DB.filter(c => c.name.toLowerCase().includes(search) || c.id.toLowerCase().includes(search) || c.date.includes(search));
            
            filtered.forEach(c => {
                const row = `
                    <tr class="capsule-row">
                        <td><span style="color: #facc15;">${c.id}</span></td>
                        <td style="font-weight:bold; color:white;">${c.name}</td>
                        <td>${c.date}</td>
                        <td>${c.size}</td>
                        <td>
                            <a href="capsulas/${c.filename}" download class="capsule-action btn-dl">‚¨áÔ∏è BAJAR</a>
                            <button onclick="decryptCapsule('${c.filename}')" class="capsule-action">üîì ABRIR</button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
            
            if (filtered.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No se encontraron c√°psulas.</td></tr>';
        }
    </script>
</body>
</html>
